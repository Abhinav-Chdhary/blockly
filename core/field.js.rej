***************
*** 87,93 ****
    }
    this.sourceBlock_ = block;
    this.updateEditable();
    block.getSvgRoot().appendChild(this.fieldGroup_);
    this.mouseUpWrapper_ =
        Blockly.bindEvent_(this.fieldGroup_, 'mouseup', this, this.onMouseUp_);
    // Bump to set the colours for dropdown arrows.
--- 87,113 ----
    }
    this.sourceBlock_ = block;
    this.updateEditable();
+ 
+   // [lyn, 10/25/13] Handle the special case where adding a title to a collapsed block.
+   // This can happen if a mutator is forced open on a procedure declaration, which happens
+   // in the current AI implementation in Blockly.FieldProcedure.onChange and
+   // in Blockly.Language.procedures_callnoreturn.setProcedureParameters.
+   // Then when the mutator is closed, the compose method of a procedure declaration
+   // is called, and this can invoke the declarations updateParams_ method, which
+   // makes new title elements for the declaration (even a collapsed one).
+   //
+   // Note: even with this "fix", can still see a few white pixels added to top of
+   // collapsed procedure decl when svg is added. I can't explain why.
+   // So it's even better to avoid adding titles to collapsed blocks in the first place!
+   // E.g., I modified proc decl compose method to avoid calling updateParams_
+   // if arg names haven't changed from before.
+ //  if (block.collapsed) {
+ //    // this.fieldGroup_.style.display = 'none';
+ //    this.getRootElement().style.display = 'none';
+ //  }
+ 
    block.getSvgRoot().appendChild(this.fieldGroup_);
+ 
    this.mouseUpWrapper_ =
        Blockly.bindEvent_(this.fieldGroup_, 'mouseup', this, this.onMouseUp_);
    // Bump to set the colours for dropdown arrows.
